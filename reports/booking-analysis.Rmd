---
title: "Restaurant Booking Analysis with Bootstrapping"
author: "Daniele Melotti"
date: "Dec 2023"
output: pdf_document
---

# 1. Data Exploration

## Load the data and convert _datetime_ into a POSIXlt date-time format

We start by loading and taking a peek at the dataset:
```{r}
bookings <- read.table("../data/first_bookings_datetime_sample.txt",
                       header=TRUE) # loading the data
str(bookings$datetime) # understanding what data type are we dealing with
```

As we can see, our data is contained in a character vector, which is not ideal for performing statistical operations. Therefore, we will convert the content of _datetime_ to a POSIXlt date-time format and extract the components that interest us.

## Calculate the time of each booking in minutes since the start of the day. Store the result in a new variable - _minday_

Since we know that EZTABLE would like to start a promotion for new members to make their bookings earlier in the day, we focus on extracting the hours and minutes after converting _datetime_ to a POSIXlt object.
```{r}
# Converting datetime to a POSIXlt object, extracting hours and minutes
hours <- as.POSIXlt(bookings$datetime, format="%m/%d/%Y %H:%M")$hour 
mins <- as.POSIXlt(bookings$datetime, format="%m/%d/%Y %H:%M")$min
```

Afterwards, we calculate the time of each booking in minutes since the start of the day. So, we multiply the hours by 60 and add the minutes, resulting in a single numerical value representing the minute of the day:
```{r}
minday <- hours * 60 + mins
```

## Plot the density of _minday_

Now, we shall see the density of _minday_ so as to get an idea about how are the values of this vector distributed:
```{r}
plot(density(minday), main="Minute of the day of first ever booking",
     col="cornflowerblue", lwd=2)
```

We see a distribution that is similar to a bimodal, with a peek of booking time around 700 minutes and another around 1200 minutes, which likely represent booking requests before lunch and dinner time. Next, we are going to conduct an analysis of the mean booking time.

# 2. Mean Booking Times - Bootstrapping

## Calculate the mean booking time and its standard error.

We shall start by computing the mean booking time and its standard error. The standard error is computed by dividing the standard deviation of the booking time by the square root of the total number of bookings:
```{r}
minday_mean <- mean(minday) # mean
minday_mean
minday_se <- sd(minday)/sqrt(length(minday)) # standard error
minday_se
```

The mean booking time corresponds to 942.4964 minutes. To make the time quickly readable and familiar, we use a custom function, located in the _functions.R_ script:
```{r}
source(file = "../R/functions.R")
mins_to_time(minday_mean)
```

So, we know that the time at which a first booking is made on average is 15:42.

## Develop a 95% confidence interval for the mean booking time.

Recall that the data we have available is only a sample; now that we know mean and standard error, we are able to build a confidence interval and get a clearer idea about the true average booking time:
```{r}
# 95% CI:
lower_bound <- minday_mean - 1.96 * minday_se
lower_bound
upper_bound <- minday_mean + 1.96 * minday_se
upper_bound
```

The interval we just built suggests that we can be 95% confident that the true average booking time is between 941.2308 and 943.2308 minutes, or that it is included between 15:41 and 15:44.
```{r}
mins_to_time(lower_bound)
mins_to_time(upper_bound)
```

## Implement a bootstrap approach to generate 2000 new samples from the original dataset.

Next, we are going to employ bootstrapping. This is a technique that resamples a dataset to create several simulated samples. To implement bootstrapping, we use the `replicate()` function, paired with `sample()`. Let's generate 2000 new samples from the original sample data:
```{r}
# Setting seed
set.seed(100)

# Creating 2000 new samples (bootstrapped samples) from the starting data
new_samples <- replicate(n = 2000,
                         sample(minday, length(minday), replace = TRUE))
```

## Visualize the distribution of the means from the bootstrapped samples.

We might be interested in seeing how the 2000 resampled datasets look like in comparison with the starting sample. We can display them on the same plot. We achieve this by applying the custom function `plot_resamples()`, included in the `functions.R` script. This function plots the density of a sample and computes its mean; if paired with `apply()`, it allows us to plot each samples' density and compute their means.
```{r}
# Create an empty plotting space
plot(density(minday), lwd=0, ylim=c(0, 0.004), main = "Starting sample vs. Bootstrapped samples")

# Plot and get means of all bootstrapped samples
sample_means <- apply(new_samples, 2, FUN=plot_resamples)

# Add starting sample to the plot
lines(density(minday), lwd = 2)

abline(v = new_samples, col=rgb(0.0, 0.4, 0.0, 0.05))
abline(v = minday_mean, lwd = 1.5, col = "tomato")
```

We notice that the bootstrapped samples are all very close to the original sample.

Now, let's visualize the 2000 means computed from the bootstrapped samples. We can take a look at how they compare with the original mean value from the starting sample.
```{r}
plot(density(new_samples), lwd = 2, col = "cornflowerblue",
     main = "Density of bootstrapped samples")
abline(v = new_samples, col=rgb(0.0, 0.4, 0.0, 0.05))
abline(v = minday_mean, lwd = 1.5, col = "tomato")
```

We see that the bootstrapped means do not vary largely from the mean of the original sample. Most values are included between 941 and 944 minutes, with only a few means being outside of this interval.

## Calculate and interpret the 95% confidence interval of the bootstrapped means.

We know what the 95% confidence interval is for the original sample's mean, now we can build a new interval for the resampled means:
```{r}
resampled_lower_bound <- mean(bootstrapped) - 1.96 * sd(bootstrapped)/sqrt(length(bootstrapped))
resampled_lower_bound
resampled_lower_bound <- mean(bootstrapped) + 1.96 * sd(bootstrapped)/sqrt(length(bootstrapped))
resampled_lower_bound
```



# 4.

summary table: original samples vs resampled; means CIs...